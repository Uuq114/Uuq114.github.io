<?xml version="1.0" encoding="utf-8"?>
<search>
  <entry>
    <title>Linux ptrace</title>
    <url>/2021/12/04/52/</url>
    <content><![CDATA[<h1 id="ç®€ä»‹">ç®€ä»‹</h1>
<p>æœ€è¿‘çš„é¡¹ç›®ä¸­éœ€è¦ç”¨åˆ°<code>ptrace</code>è¿™æ ·çš„ç³»ç»Ÿè°ƒç”¨å‡½æ•°ï¼Œè¿™é‡Œæ€»ç»“ä¸€ä¸‹è¦æ³¨æ„çš„åœ°æ–¹ã€‚</p>
<span id="more"></span>
<h2 id="ç³»ç»Ÿè°ƒç”¨">ç³»ç»Ÿè°ƒç”¨</h2>
<p>åœ¨ç¼–å†™ç¨‹åºçš„æ—¶å€™ï¼Œæˆ‘ä»¬ä¼šä½¿ç”¨ç¼–ç¨‹è¯­è¨€æä¾›çš„åº“å‡½æ•°ï¼Œä¾‹å¦‚<code>read()</code>ã€<code>fork()</code>ï¼Œè¿™äº›åº“å‡½æ•°å®é™…ä¸Šæ˜¯å¯¹ä¸€äº›åº•å±‚æ“ä½œçš„åŒ…è£…ã€‚è¿™äº›åº•å±‚æ“ä½œå°±ç§°ä¸ºç³»ç»Ÿè°ƒç”¨ã€‚</p>
<p>ä¸€ä¸ªç³»ç»Ÿè°ƒç”¨åŒ…æ‹¬ï¼š</p>
<ul>
<li>ç¼–å·ï¼Œç”¨äºåŒºåˆ†</li>
<li>å‚æ•°</li>
<li>å¯„å­˜å™¨ï¼Œç”¨äºå­˜æ”¾å‚æ•°</li>
</ul>
<p>ä¾‹å¦‚ï¼Œ<code>write()</code>ä¼šè¢«è½¬æ¢æˆï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">write(2, &quot;Hello&quot;, 5);</span><br><span class="line">/*----------------*/</span><br><span class="line">movl $1,%eax	; ç³»ç»Ÿè°ƒç”¨å·</span><br><span class="line">movl $2,%ebx</span><br><span class="line">movl $hello,%ecx</span><br><span class="line">movl $5,%edx</span><br><span class="line">int $0x80		; ä¸­æ–­</span><br></pre></td></tr></table></figure>
<h2 id="ptrace"><code>ptrace</code></h2>
<p><code>ptrace</code>å¯ä»¥è®©ä¸€ä¸ªè¿›ç¨‹ï¼ˆtracerï¼‰ç›‘è§†å’Œæ§åˆ¶å¦ä¸€ä¸ªè¿›ç¨‹ï¼ˆtraceeï¼‰ï¼Œå¹¶ä¸”å¯ä»¥æ”¹å˜å†…å­˜å’Œå¯„å­˜å™¨çš„å†…å®¹ï¼Œä¸€èˆ¬ç”¨äºdebugã€‚</p>
<p><code>ptrace</code>èµ·ä½œç”¨çš„æ—¶é—´ï¼šåœ¨æ‰§è¡Œsystem callä¹‹å‰ï¼Œkernelä¼šæ£€æŸ¥processæ˜¯å¦è¢«è¿½è¸ªã€‚å¦‚æœæ˜¯çš„ï¼Œé‚£ä¹ˆkernelä¼šä¸­æ­¢traceeå¹¶å°†æ§åˆ¶æƒäº¤ç»™è¿½è¸ªè€…ã€‚</p>
<p><strong>ä¸€ä¸ªä¾‹å­</strong>ï¼š</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/ptrace.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/wait.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/user.h&gt;</span> <span class="comment">// ORIG_RAX</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/reg.h&gt;</span> <span class="comment">// ORIG_RAX</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">pid_t</span> child;</span><br><span class="line">    <span class="keyword">long</span> orig_eax;</span><br><span class="line">    child = fork();</span><br><span class="line">    <span class="keyword">if</span>(child == <span class="number">0</span>) &#123;</span><br><span class="line">        ptrace(PTRACE_TRACEME, <span class="number">0</span>, <span class="literal">NULL</span>, <span class="literal">NULL</span>);</span><br><span class="line">        execl(<span class="string">&quot;/bin/ls&quot;</span>, <span class="string">&quot;ls&quot;</span>, <span class="literal">NULL</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        wait(<span class="literal">NULL</span>);</span><br><span class="line">        orig_eax = ptrace(PTRACE_PEEKUSER,</span><br><span class="line">                          child, <span class="number">8</span> * ORIG_RAX, <span class="comment">// åœ¨64ä½çš„æœºå™¨ä¸Šï¼Œæ‰€ä»¥è¦ä¹˜8ï¼Œå¦‚æœæ˜¯32ä½ä¹˜4</span></span><br><span class="line">                          <span class="literal">NULL</span>);</span><br><span class="line">        <span class="comment">/* ä¹Ÿå¯ä»¥ç”¨ä¸‹é¢çš„æ–¹æ³•å¾—åˆ°orig_eaxï¼Œä¸éœ€è¦è®¡ç®—registerä½ç½®</span></span><br><span class="line"><span class="comment">       	struct user_regs_struct regs;</span></span><br><span class="line"><span class="comment">		ptrace(PTRACE_GETREGS, child, NULL, &amp;regs);</span></span><br><span class="line"><span class="comment">		printf(&quot;The child made a system call %ldn&quot;, regs.orig_rax);</span></span><br><span class="line"><span class="comment">        */</span></span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;The child made a &quot;</span></span><br><span class="line">               <span class="string">&quot;system call %ld\n&quot;</span>, orig_eax);</span><br><span class="line">        ptrace(PTRACE_CONT, child, <span class="literal">NULL</span>, <span class="literal">NULL</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è¾“å‡ºæ˜¯ï¼š</p>
<figure>
<img src="output.png" alt="output" /><figcaption aria-hidden="true">output</figcaption>
</figure>
<p>å¯¹ä¾‹å­çš„åˆ†æï¼š</p>
<p>åœ¨12è¡Œè°ƒç”¨äº†<code>fork</code>ï¼Œchildä¼šå…ˆè°ƒç”¨<code>ptrace</code>ï¼Œ<code>flag</code>ä¸º<code>PTRACE_TRACEME</code>ï¼Œå‘Šè¯‰kernelå®ƒæ­£åœ¨è¢«è¿½è¸ªï¼Œäºæ˜¯åœ¨childæ‰§è¡Œ<code>execve</code> system callæ—¶ï¼Œæ§åˆ¶æƒä¼šè¢«äº¤ç»™parentã€‚</p>
<p>parentä½¿ç”¨<code>wait</code>ç­‰å¾…kernelçš„é€šçŸ¥ã€‚ä¹‹åparentå¯ä»¥æ£€è§†å‚æ•°ï¼ˆè¯»registerï¼‰ã€‚</p>
<p>å½“ç³»ç»Ÿè°ƒç”¨å‘ç”Ÿæ—¶ï¼Œkernelä¼šä¿å­˜eaxçš„å†…å®¹ï¼Œparentå¯ä»¥ç”¨<code>ptrace</code>çš„<code>PTRACE_PEEKUSER</code>å‚æ•°è¯»è¿™ä¸ªå€¼ï¼Œå¦‚19è¡Œã€‚</p>
<p>parentå®Œæˆæ£€è§†ä¹‹åï¼Œä»¥<code>PTRACE_CONT</code>å‚æ•°è°ƒç”¨<code>ptrace</code>ï¼Œå¯ä»¥ç»§ç»­system callã€‚</p>
<blockquote>
<p>è¿è¡Œçš„ç»“æœæ˜¯<code>59</code>ï¼Œå’ŒåŸç½‘å€çš„ç»“æœ<code>11</code>ä¸åŒï¼ŒåŸå› æ˜¯ä»€ä¹ˆï¼Ÿ</p>
<p><code>asm/unistd.h</code>æ–‡ä»¶åœ¨i386ã€ILP32å’Œ64ä½æœºä¸Šçš„ä¸åŒï¼Œ<code>asm/unistd_64.h</code>ä¸­æœ‰ï¼š<code>#define __NR_execve 59</code></p>
</blockquote>
<p><code>ptrace</code>çš„<strong>ç”¨æ³•</strong>ï¼š</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">long</span> <span class="title">ptrace</span><span class="params">(<span class="keyword">enum</span> __ptrace_request request,</span></span></span><br><span class="line"><span class="params"><span class="function">            <span class="keyword">pid_t</span> pid,</span></span></span><br><span class="line"><span class="params"><span class="function">            <span class="keyword">void</span> *addr,</span></span></span><br><span class="line"><span class="params"><span class="function">            <span class="keyword">void</span> *data)</span></span>;</span><br></pre></td></tr></table></figure>
<p><code>request</code>å‚æ•°æŒ‡å®šäº†<code>ptrace</code>çš„è¡Œä¸ºå’Œåé¢å‚æ•°çš„ç”¨æ³•ã€‚</p>
<blockquote>
<p><code>PTRACE_TRACEME</code>, <code>PTRACE_PEEKTEXT</code>, <code>PTRACE_PEEKDATA</code>, <code>PTRACE_PEEKUSER</code>, <code>PTRACE_POKETEXT</code>, <code>PTRACE_POKEDATA</code>, <code>PTRACE_POKEUSER</code>, <code>PTRACE_GETREGS</code>, <code>PTRACE_GETFPREGS</code>, <code>PTRACE_SETREGS</code>, <code>PTRACE_SETFPREGS</code>, <code>PTRACE_CONT</code>, <code>PTRACE_SYSCALL</code>, <code>PTRACE_SINGLESTEP</code>, <code>PTRACE_DETACH</code></p>
</blockquote>
<p><strong>è¿½è¸ªæ­£åœ¨è¿è¡Œçš„process</strong></p>
<p>åœ¨ä¸Šé¢ï¼Œchildä½¿ç”¨<code>PTRACE_TRACEME</code>æ¥è·å¾—è¿½è¸ªï¼Œå¦‚æœæˆ‘ä»¬éœ€è¦è¿½è¸ªä¸€ä¸ªæ­£åœ¨è¿è¡Œçš„processï¼Œæˆ‘ä»¬éœ€è¦ä½¿ç”¨<code>PTRACE_ATTACH</code>ã€‚</p>
<p><u>å½“<code>PTRACE_ATTACH</code>å’Œ<code>pid</code>ä¸€èµ·ä½¿ç”¨æ—¶ï¼Œçº¦ç­‰äºprocessè°ƒç”¨äº†<code>PTRACE_TRACEME</code>å¹¶ä¸”å˜æˆäº†tracerçš„child</u>ã€‚traceeä¼šæ”¶åˆ°<code>SIGSTOP</code>ä¿¡å·ï¼Œæˆ‘ä»¬åœ¨ä¿®æ”¹å®Œæ•°æ®ä¹‹åï¼Œéœ€è¦è°ƒç”¨<code>PTRACE_DETACH</code>ã€‚</p>
<p><code>test.c</code></p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;   <span class="keyword">int</span> i;</span><br><span class="line">    <span class="keyword">for</span>(i = <span class="number">0</span>;i &lt; <span class="number">10</span>; ++i) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;My counter: %d\n&quot;</span>, i);</span><br><span class="line">        sleep(<span class="number">2</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>tracer.c</code></p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/ptrace.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/wait.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/user.h&gt;</span>   <span class="comment">/* For user_regs_struct</span></span></span><br><span class="line"><span class="comment"><span class="meta">                             etc. */</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/reg.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> *argv[])</span></span></span><br><span class="line"><span class="function"></span>&#123;   <span class="keyword">pid_t</span> traced_process;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">user_regs_struct</span> <span class="title">regs</span>;</span></span><br><span class="line">    <span class="keyword">long</span> ins;</span><br><span class="line">    <span class="keyword">if</span>(argc != <span class="number">2</span>) &#123;</span><br><span class="line">        <span class="comment">// printf(&quot;Usage: %s &lt;pid to be traced&gt;\n&quot;, argv[0], argv[1]);</span></span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;Usage: %s &lt;pid to be traced&gt;\n&quot;</span>, argv[<span class="number">0</span>]);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    traced_process = atoi(argv[<span class="number">1</span>]);</span><br><span class="line">    ptrace(PTRACE_ATTACH, traced_process,</span><br><span class="line">           <span class="literal">NULL</span>, <span class="literal">NULL</span>);</span><br><span class="line">    wait(<span class="literal">NULL</span>);</span><br><span class="line">    ptrace(PTRACE_GETREGS, traced_process,</span><br><span class="line">           <span class="literal">NULL</span>, &amp;regs);</span><br><span class="line">    ins = ptrace(PTRACE_PEEKTEXT, traced_process,</span><br><span class="line">                 regs.rip, <span class="literal">NULL</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;EIP: %llx Instruction executed: %lx\n&quot;</span>,</span><br><span class="line">           regs.rip, ins);</span><br><span class="line">    ptrace(PTRACE_DETACH, traced_process,</span><br><span class="line">           <span class="literal">NULL</span>, <span class="literal">NULL</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>tracer</code>ä¼šattachåˆ°testï¼Œæ£€è§†å®ƒçš„<code>eip</code>ï¼ˆinstruction pointerï¼‰ï¼Œç„¶ådetachã€‚</p>
<p>å¦‚æœè¦æ³¨å…¥ä»£ç ï¼Œéœ€è¦åœ¨ä¸­æ­¢traceeä¹‹åä½¿ç”¨<code>PTRACE_POKETEXT</code>ï¼Œç„¶å<code>PTRACE_POKEDATA</code>ã€‚</p>
<p>å‚è€ƒé“¾æ¥ï¼š</p>
<p>https://www.linuxjournal.com/article/6100</p>
]]></content>
      <categories>
        <category>æ“ä½œç³»ç»Ÿ</category>
      </categories>
      <tags>
        <tag>Linux</tag>
      </tags>
  </entry>
  <entry>
    <title>åšå®¢æ›´æ–°æ—¥å¿—</title>
    <url>/2021/11/13/47/</url>
    <content><![CDATA[<h1 id="åšå®¢æ›´æ–°æ—¥å¿—">åšå®¢æ›´æ–°æ—¥å¿—</h1>
<p>è¿™é‡Œæ˜¯è®°å½•åšå®¢æ›´æ–°çš„æ—¥å¿—ï¼ŒåŒ…æ‹¬å’Œåšå®¢å»ºè®¾ç›¸å…³çš„<code>md</code>ã€ä¸ºåšå®¢å¢åŠ çš„åŠŸèƒ½ã€‚</p>
<span id="more"></span>
<p>TODOsï¼š</p>
<ul>
<li>æœ‰æ–°è¯„è®ºæ—¶é‚®ä»¶é€šçŸ¥</li>
</ul>
<p>2023.05.14ï¼š</p>
<ul>
<li>æ”¯æŒ LaTeX æ˜¾ç¤º</li>
</ul>
<p>2023.05.13ï¼š</p>
<ul>
<li>å¢åŠ å¯¼èˆªæ é€‰é¡¹</li>
<li>å¢åŠ  Valine è¯„è®º</li>
<li>ä¿®æ”¹ç½‘ç«™è¿è¡Œä¿¡æ¯æ˜¾ç¤º</li>
</ul>
<p>2021.11.24ï¼š</p>
<ul>
<li>åšæ–‡åªæ˜¾ç¤ºç®€ä»‹</li>
<li>æ˜¾ç¤ºåšæ–‡ç»Ÿè®¡æ•°æ®ã€æ˜¾ç¤ºå’•å’•å¤©æ•°ğŸ•Šï¸</li>
</ul>
<p>2021.11.12ï¼š</p>
<ul>
<li>åˆ›å»ºåšå®¢</li>
<li>è®¾ç½®<code>NexT</code>ä¸»é¢˜</li>
<li>ä¸Šä¼ äº†ç¬¬ä¸€ç¯‡åšå®¢</li>
</ul>
]]></content>
      <categories>
        <category>Blog</category>
      </categories>
  </entry>
  <entry>
    <title>Elasticsearch ä½¿ç”¨è®°å½•</title>
    <url>/2023/05/26/26/</url>
    <content><![CDATA[<h2 id="x00-ç®€ä»‹">0x00 ç®€ä»‹</h2>
<p>æœ¬æ–‡ä»‹ç»äº† ES åœ¨å®è·µä¸Šçš„ä¸€äº›å†…å®¹ï¼ŒåŒ…æ‹¬ï¼š</p>
<ul>
<li>ES ä¸­çš„æ¦‚å¿µ</li>
<li>é«˜å¯ç”¨çš„ ES é›†ç¾¤</li>
<li>ES è°ƒä¼˜çš„è®¾ç½®é¡¹</li>
</ul>
<span id="more"></span>
<h2 id="x01-ä¸€äº›åè¯">0x01 ä¸€äº›åè¯</h2>
<p>é¦–å…ˆä»‹ç»ä¸€äº› ES ä¸­çš„æ¦‚å¿µï¼š</p>
<ul>
<li>Indexï¼šES index å°±æ˜¯ä¸€ç»„ shardï¼Œè¿™äº› shard åˆ†å¸ƒåœ¨å¤šä¸ª node ä¸Šï¼Œæ¯ä¸ª shared éƒ½æ˜¯ä¸€ä¸ª self-contained index</li>
<li>shardï¼šæœ‰ä¸¤ç§ç±»å‹ï¼Œprimary å’Œ replicaã€‚replica å¯ä»¥åšå¤‡ä»½å’ŒæŸ¥è¯¢ã€‚primary çš„æ•°é‡åœ¨åˆ›å»ºç´¢å¼•å°±ç¡®å®šäº†ï¼Œä½†æ˜¯ replica å¯ä»¥åœ¨åç»­è°ƒæ•´</li>
</ul>
<h2 id="x02-é«˜å¯ç”¨">0x02 é«˜å¯ç”¨</h2>
<p>é«˜å¯ç”¨çš„ ES é›†ç¾¤æœ‰ä¸‰ä¸ªæ–¹é¢ï¼š</p>
<ul>
<li>ä¸€ä¸ªé›†ç¾¤å†…éƒ¨ï¼Œå¯èƒ½æœ‰èŠ‚ç‚¹æŒ‚äº†</li>
<li>å¤šä¸ªé›†ç¾¤ï¼Œæ¶‰åŠé›†ç¾¤ä¹‹é—´çš„å¤åˆ¶ï¼Œfollower cluster å¯ä»¥ä½œä¸º failoverï¼Œæˆ–è€…å°±è¿‘æä¾›æœåŠ¡çš„ geo-replica</li>
<li>å®šæœŸçš„ snapshot</li>
</ul>
<p>ä¸€ä¸ªå¯é çš„ ES é›†ç¾¤éœ€è¦æœ‰ï¼š</p>
<ul>
<li>è‡³å°‘ä¸‰ä¸ª master å¤‡é€‰çš„ node</li>
<li>æ¯ä¸ª role è‡³å°‘æœ‰ä¸¤ä¸ªèŠ‚ç‚¹</li>
<li>æ¯ä¸ª shard è‡³å°‘æœ‰ä¸¤ä¸ª copyï¼Œprimary å’Œ replica</li>
</ul>
<p>åœ¨å‰©ä½™çš„èŠ‚ç‚¹ä¸Šï¼ŒES ä¼šè‡ªåŠ¨é‡å»º failed shardï¼Œè®© health å›åˆ° greenã€‚å¦‚æœè¦è®©å•èŠ‚ç‚¹çš„ ES é›†ç¾¤å¥åº·çŠ¶æ€å˜ä¸º greenï¼Œéœ€è¦å°† index çš„ <code>index.number_of_replicas</code>è®¾ç½®ä¸º<code>0</code></p>
<h2 id="x03-æ€§èƒ½è°ƒä¼˜">0x03 æ€§èƒ½è°ƒä¼˜</h2>
<p><strong>shard</strong></p>
<p>è¦è€ƒè™‘çš„é…ç½®é¡¹ï¼šprimary shard æ•°é‡ï¼Œshard size</p>
<ul>
<li>å¯¹äºæ—¶åºç±»çš„æ•°æ®ï¼Œshard size ä¸€èˆ¬åœ¨ 20-40 GB</li>
<li>ä¸€ä¸ª node å¯ä»¥ç®¡ç†çš„ shard æ•°å’Œå †å¤§å°æœ‰å…³ï¼Œ1 GB heap å¯¹åº” 20 ä¸ª shard</li>
</ul>
<p>å‚è€ƒï¼šhttps://www.elastic.co/guide/en/elasticsearch/reference/current/advanced-configuration.html#set-jvm-heap-size</p>
]]></content>
      <categories>
        <category>æœç´¢å¼•æ“</category>
      </categories>
      <tags>
        <tag>Elasticsearch</tag>
      </tags>
  </entry>
  <entry>
    <title>Elasticsearch 101</title>
    <url>/2023/05/25/11/</url>
    <content><![CDATA[<h2 id="x00-ç®€ä»‹">0x00 ç®€ä»‹</h2>
<p>Elasticsearch æ˜¯ä¸€ä¸ªåˆ†å¸ƒå¼çš„å…¨æ–‡æœç´¢å¼•æ“ï¼Œå¯ä»¥è¿‘ä¹å®æ—¶åœ°å­˜å‚¨ã€æ£€ç´¢æ•°æ®ã€‚ES çš„åº•å±‚åŸºäº Lucene å…¨æ–‡ä¿¡æ¯æ£€ç´¢å·¥å…·åŒ…ï¼Œå¦ä¸€ä¸ªæœç´¢ç³»ç»Ÿ Solr ä¹Ÿæ˜¯åŸºäº Lucene å¼€å‘çš„ã€‚</p>
<ul>
<li>å€’æ’ç´¢å¼•</li>
<li>ES å¯¹å­˜å‚¨ä½¿ç”¨çš„ä¼˜åŒ–</li>
<li>ES å’Œ MySQL çš„æ¯”è¾ƒ</li>
</ul>
<span id="more"></span>
<h2 id="x01-es-101">0x01 ES 101</h2>
<p><strong>å€’æ’ç´¢å¼•</strong></p>
<p>åœ¨è°·æ­Œç­‰æœç´¢å¼•æ“ä¸­ï¼Œä¸€ç§å¸¸è§çš„æœç´¢æ–¹å¼æ˜¯æ ¹æ®å…³é”®è¯è¿”å›ç›¸å…³çš„æ–‡æ¡£ï¼Œå³<code>word =&gt; doc</code>ã€‚<code>doc =&gt; word</code>è¿™ç§æŸ¥è¯¢çš„ç´¢å¼•è¢«ç§°ä¸ºæ­£å‘ç´¢å¼•ï¼ˆforward indexï¼‰ï¼Œé‚£ä¹ˆ<code>word =&gt; doc</code>è¿™ç§æŸ¥è¯¢çš„ç´¢å¼•å°±å«åšå€’æ’ç´¢å¼•ï¼ˆåå‘ç´¢å¼•ï¼Œinverted indexï¼‰äº†ã€‚</p>
<figure class="highlight apache"><table><tr><td class="code"><pre><span class="line"><span class="attribute">DICTIONARY</span>     =====&gt;     DOC</span><br><span class="line"><span class="attribute">ada</span>						<span class="meta"> [1,2,3]</span></span><br><span class="line"><span class="attribute">bob</span>                     <span class="meta"> [2]</span></span><br></pre></td></tr></table></figure>
<p><strong>ES çš„ Dictionary ä¼˜åŒ–</strong></p>
<p>é™¤äº†ä¿å­˜æœ€åŸºæœ¬çš„<code>word =&gt; doc</code>çš„æ˜ å°„ï¼Œä¸ºäº†åŠ é€Ÿ<code>word</code>è¿™ä¸€å±‚çš„æŸ¥è¯¢ï¼ŒLucene åœ¨<code>Dictionary</code>çš„å·¦è¾¹åŠ äº†ä¸€å±‚â€œå­—å…¸æ ‘â€ï¼Œé€šè¿‡å­—å…¸æ ‘å¯ä»¥å®šä½å•è¯çš„å—ï¼Œå†åœ¨å—ä¸­ç”¨äºŒåˆ†æŸ¥æ‰¾å¾—åˆ°å•è¯çš„ä½ç½®ã€‚</p>
<blockquote>
<p>å¼•å…¥å­—å…¸æ ‘æ˜¯ä¸ºäº†åœ¨ä¸æŠŠå­—å…¸å…¨éƒ¨ç¼“å­˜åˆ°å†…å­˜çš„å‰æä¸‹ï¼Œä¹Ÿèƒ½åŠ é€ŸæŸ¥è¯¢å•è¯</p>
<p>é™¤äº†å­—å…¸æ ‘ï¼ŒES è¿˜å¼•å…¥äº†FSTï¼ˆæœ‰é™çŠ¶æ€è½¬æ¢å™¨ï¼ŒFinite State Transducersï¼‰æ¥å‡å°‘å†…å­˜å ç”¨</p>
</blockquote>
<p><strong>ES çš„ Posting list ä¼˜åŒ–</strong></p>
<p>ES æœ€å³è¾¹çš„ä¸€å±‚ DOCï¼Œè™½ç„¶åªæ˜¯ä¸€äº›æ–‡æ¡£ ID æ•°ç»„ï¼Œä½†æ˜¯ ES ä¹Ÿåœ¨è¿™é‡Œåšäº†ä¼˜åŒ–ï¼Œä¼˜åŒ–çš„ç›®æ ‡æœ‰ï¼š</p>
<ul>
<li>èŠ‚çœç£ç›˜ç©ºé—´</li>
<li>å¿«é€Ÿæ±‚äº¤é›†ã€å¹¶é›†</li>
</ul>
<p>èŠ‚çœç£ç›˜ç©ºé—´ï¼š</p>
<ul>
<li><p>å­˜å‚¨ DOC ID çš„å¢é‡ + åˆ†å—ï¼šä»å­˜å‚¨åŸå§‹çš„æ–‡æ¡£åˆ—è¡¨ï¼Œå˜æˆå­˜å‚¨æ–‡æ¡£ ID çš„å¢é‡ï¼Œæ¯”å¦‚ï¼š</p>
<figure class="highlight accesslog"><table><tr><td class="code"><pre><span class="line"><span class="string">[73, 300, 302, 332, 343, 372]</span> =&gt;</span><br><span class="line"><span class="string">[73, 227, 2, 30, 11, 29]</span></span><br></pre></td></tr></table></figure>
<p>å› ä¸º Lucene æ˜¯ç”¨ segment å­˜å‚¨æ•°æ®çš„ï¼ˆæœ€å¤šå­˜ 65536 ä¸ª IDï¼‰ï¼Œæ¯ä¸ª segment è¢«åˆ†æˆå—ï¼Œæ¯ä¸ªå—æœ€å¤šå­˜ 256 ä¸ª IDï¼Œè¿™æ ·ç”¨å¢é‡å­˜å‚¨åï¼Œå¯ä»¥ç”¨æ›´å°‘ä½æ•°å­˜æ•°æ®</p></li>
<li><p>æŒ‰éœ€åˆ†é…ç©ºé—´ï¼šåœ¨ä¸Šé¢åˆ†å—çš„åŸºç¡€ä¸Šï¼Œæ£€æŸ¥æ¯ä¸ªå—çš„æœ€å¤§å€¼éœ€è¦åˆ†é…å¤šå°‘ä½ï¼Œè¾¾åˆ°æŒ‰éœ€åˆ†é…ã€‚æ¯”å¦‚<code>227</code>å°±éœ€è¦8 ä½ï¼Œ<code>30</code>å°±éœ€è¦ 5 ä½</p></li>
</ul>
<p>å¿«é€Ÿæ±‚äº¤å¹¶é›†ï¼š</p>
<p>ä½¿ç”¨ bitmapï¼Œç”¨ä½è¿ç®—</p>
<p><strong>ä¸ºä»€ä¹ˆ ES ä¸ä½¿ç”¨ B+ æ ‘å­˜å‚¨ï¼Ÿ</strong></p>
<p>B+ æ ‘ä¸»è¦è®¾è®¡ç›®çš„æ˜¯å‡å°‘æœç´¢æ—¶è®¿é—®ç£ç›˜çš„æ¬¡æ•°ï¼Œè€Œ Lucene ç­‰æœç´¢å¼•æ“è®¾è®¡çš„æ—¶å€™ï¼Œè¿½æ±‚çš„ç›®æ ‡æ˜¯å€’æ’å‹ç¼©ç‡&amp;å€’æ’è§£å‹é€Ÿåº¦&amp;å€’æ’ Bool è¿ç®—é€Ÿåº¦ã€‚å–å€’æ’åˆ°å†…å­˜è¿ç®—çš„æ—¶å€™ï¼Œæ˜¯è¿ç»­è¯»å–ï¼Œæ—¶é—´å¼€é”€å’Œå€’æ’çš„å¤§å°æœ‰å…³ç³»ï¼Œæ‰€ä»¥å¹¶ä¸é€‚åˆç”¨ B+ æ•°ã€‚ åŒç† MySQL ç­‰æ•°æ®åº“ä½¿ç”¨ç´¢å¼•çš„ç›®çš„æ˜¯å¿«é€Ÿå®šä½æŸä¸€è¡Œæ•°æ®ï¼Œè‹¥ä½¿ç”¨å€’æ’è¿™ç§çº¿æ€§åŒ–çš„æ•°æ®ç»“æ„å­˜å‚¨æ•°æ®ï¼Œå…¶æŸ¥æ‰¾çš„æ—¶å€™è®¿é—®ç£ç›˜çš„æ¬¡æ•°ä¼šè¿œå¤§äºä½¿ç”¨ B+ çš„æ•°æ®åº“ã€‚</p>
<h2 id="x02-sequel">0x02 Sequel</h2>
<p>åé¢å¯èƒ½ä» ES çš„ä½¿ç”¨æ–¹é¢å†å†™ä¸€ç¯‡ postï¼Œä»‹ç» ES çš„ç´¢å¼•ã€æ˜ å°„ã€åˆ†ç‰‡ã€å¤‡ä»½ç›¸å…³çš„</p>
]]></content>
      <categories>
        <category>æœç´¢å¼•æ“</category>
      </categories>
      <tags>
        <tag>Elasticsearch</tag>
      </tags>
  </entry>
  <entry>
    <title>my first blog</title>
    <url>/2021/11/12/17/</url>
    <content><![CDATA[<p>HELLO WORLD</p>
<span id="more"></span>
]]></content>
      <categories>
        <category>éšç¬”</category>
      </categories>
  </entry>
  <entry>
    <title>Jane Street Puzzle @ 2023.1</title>
    <url>/2023/05/14/39/</url>
    <content><![CDATA[<h1 id="ç®€ä»‹">ç®€ä»‹</h1>
<p>è¿™é“é¢˜ç›®æ˜¯ Jane Street åœ¨ 2023.1 å‡ºçš„ï¼ŒåŸæ–‡é“¾æ¥åœ¨<a href="https://www.janestreet.com/puzzles/lesses-more-index/">è¿™é‡Œ</a>ã€‚</p>
<p>é¢˜ç›®å¤§æ„æ˜¯ï¼šç»™å®šä¸€ä¸ªå››å…ƒçš„æ•°å­—åºåˆ—<code>(a,b,c,d)</code>ï¼Œä»¥åŠåºåˆ—çš„å˜åŒ–è§„åˆ™ï¼Œéœ€è¦æ‰¾åˆ°ç»è¿‡å˜æ¢åèƒ½å˜æˆ<code>(0,0,0,0)</code>çš„åºåˆ—ä¸­ï¼Œå˜æ¢æ­¥æ•°æœ€å¤šåŒæ—¶<code>a+b+c+d</code>æœ€å°çš„é‚£ä¸ªåºåˆ—ã€‚</p>
<p>å…¶ä¸­ï¼Œåºåˆ—çš„å˜åŒ–è§„åˆ™å½¢å¦‚ï¼š <span class="math display">\[
(a,b,c,d) \stackrel{f}{\longrightarrow}
(\lvert a-b \rvert, \lvert b-c \rvert, \lvert c-d \rvert, \lvert d-a \rvert)
\]</span> æœ€åè¦æ‰¾çš„åºåˆ—çš„é™åˆ¶æ¡ä»¶æ˜¯ï¼š <span class="math display">\[
\begin{align}
\begin{matrix}
    &amp;(1)&amp; 0 \le a,b,c,d \le 10^7 \\
    &amp;(2)&amp; sum(a+b+c+d) \rightarrow min \\
    &amp;(3)&amp; num(f) \rightarrow max \\
\end{matrix}
\end{align}
\]</span> å®šä¹‰äº†ç‰¹æ®Šæƒ…å†µ<code>f(0,0,0,0)=1</code></p>
<span id="more"></span>
<h2 id="è§£æ³•">è§£æ³•</h2>
<p>è®¾è¾“å…¥åºåˆ—ä¸º<code>(a,b,c,d)</code></p>
<p>æ³¨æ„åˆ°æ»¡è¶³<code>a&gt;b&gt;c&gt;d</code>çš„åºåˆ—çš„å˜æ¢æ¬¡æ•°ä¸€èˆ¬ä¼šå¤§ä¸€äº›ï¼Œå› ä¸ºç»è¿‡<code>f</code>å˜æ¢ï¼Œå¤§å¤šæ•°çš„æƒ…å†µéƒ½æ˜¯å››ä¸ªæ•°å‚å·®ä¸é½çš„æƒ…å†µï¼Œè¿ç»­æˆç«‹çš„å¤§å°å…³ç³»æ¯”è¾ƒå°‘è§ï¼Œè¿™é‡Œå°±å‡è®¾<code>a&gt;b&gt;c&gt;d</code>äº†</p>
<p>å®šä¹‰ä¸€ä¸ªå½’ä¸€åŒ–å¤„ç†ï¼ˆè®°ä¸º<code>N</code>å˜æ¢ï¼‰ï¼š <span class="math display">\[
(a,b,c,d) \rightarrow (a-d,b-d,c-d,0) \rightarrow (1,\frac{b-d}{a-d},\frac{c-d}{b-d},0)
\]</span> ä¸Šå¼ç»“æœè®°ä¸º<code>(1,x,y,0)</code>ï¼ŒæŒ‰ç…§å‰é¢å‡è®¾çš„<code>a&gt;b&gt;c&gt;d</code>ï¼Œè¿™é‡Œæœ‰<code>1&gt;x&gt;y&gt;0</code></p>
<p>è¦è®©<code>f</code>å˜æ¢çš„æ¬¡æ•°å°½é‡å¤šï¼Œæ¯æ¬¡å˜æ¢ç»“æœçš„å½’ä¸€åŒ–å½¢å¼å°±éœ€è¦å°½é‡æ¥è¿‘ã€‚æœ€æç«¯çš„æƒ…å†µæ˜¯ä¸å˜ï¼Œè¿™æ ·å°±å¯ä»¥æ— é™ä¸‹å»äº†</p>
<p>åœ¨å½’ä¸€åŒ–ç©ºé—´ä¸­ï¼Œå¯¹<code>(1,x,y,0)</code>åš<code>f</code>å˜æ¢ï¼š <span class="math display">\[
(1,x,y,0) \stackrel{f}{\longrightarrow} (1-x,x-y,y,1) \\
\]</span> <code>N</code>å˜æ¢éœ€è¦ä»¥å››å…ƒç»„æœ€å¤§çš„æ•°ä½œä¸ºçº¦æ•°ï¼šï¼ˆè¿™é‡Œå››å…ƒç»„å¯èƒ½è¿˜æœ‰å…¶ä»–çš„æ’æ³•ï¼‰ <span class="math display">\[
(1,1-x,x-y,y) \stackrel{N}{\longrightarrow} (1,\frac{1-x-y}{1-y},\frac{x-2y}{1-y},0) \\
æˆ–è€…ï¼š
(1,y,x-y,1-x) \stackrel{N}{\longrightarrow} (1,\frac{x+y-1}{x},\frac{2x-y+1}{x},0)
\]</span> ä»¥ç¬¬ä¸€è¡Œä¸ºä¾‹ï¼Œå’Œå¼€å§‹å½’ä¸€åŒ–çš„<code>(1,x,y,0)</code>æ¥è¿‘ï¼Œå¯ä»¥æ¶ˆå»<code>y</code>å¾—åˆ°ä¸€ä¸ªæ–¹ç¨‹ï¼š <span class="math display">\[
x^3-4x^2+6x-2=0
\]</span> è§£æ–¹ç¨‹å¯ä»¥å¾—åˆ°ä¸€ä¸ª<code>x=0.456311, y=0.160713</code></p>
<p>æ¥ä¸‹æ¥éœ€è¦ç”¨å½’ä¸€åŒ–çš„ç»“æœåœ¨é¢˜ç›®çš„èŒƒå›´<code>[1,1e8]</code>ä¸­åæ¨ä¸€ä¸ªåˆå§‹åºåˆ—å‡ºæ¥ï¼Œæ¨å¯¼è¿‡ç¨‹å°±çœç•¥äº†</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">x = <span class="number">0.8392867552141612</span></span><br><span class="line">y = <span class="number">0.5436890126920764</span></span><br><span class="line"></span><br><span class="line">MAX_NUM = <span class="number">10000000</span></span><br><span class="line">ERROR = <span class="number">1e-3</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">check</span>(<span class="params">a, b, c</span>):</span></span><br><span class="line">    d = <span class="number">0</span></span><br><span class="line">    cnt = <span class="number">1</span></span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        a, b, c, d = <span class="built_in">abs</span>(a - b), <span class="built_in">abs</span>(b - c), <span class="built_in">abs</span>(c - d), <span class="built_in">abs</span>(d - a)</span><br><span class="line">        cnt += <span class="number">1</span></span><br><span class="line">        <span class="keyword">if</span> a == <span class="number">0</span> <span class="keyword">and</span> b == <span class="number">0</span> <span class="keyword">and</span> c == <span class="number">0</span> <span class="keyword">and</span> d == <span class="number">0</span>:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&#x27;check(<span class="subst">&#123;a&#125;</span>,<span class="subst">&#123;b&#125;</span>,<span class="subst">&#123;c&#125;</span>,0) is true, count: <span class="subst">&#123;cnt&#125;</span>&#x27;</span>)</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">        <span class="keyword">elif</span> cnt &gt;= <span class="number">1000</span>:</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">find</span>():</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(MAX_NUM):</span><br><span class="line">        <span class="comment"># print(i)</span></span><br><span class="line">        first = x * i</span><br><span class="line">        second = y * i</span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">abs</span>(<span class="built_in">int</span>(first) - first) &lt;= ERROR <span class="keyword">and</span> <span class="built_in">abs</span>(<span class="built_in">int</span>(second) - second) &lt;= ERROR:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&#x27;i, first, second: <span class="subst">&#123;i&#125;</span>, <span class="subst">&#123;first&#125;</span>, <span class="subst">&#123;second&#125;</span>&#x27;</span>)</span><br><span class="line">            check(i, <span class="built_in">int</span>(first), <span class="built_in">int</span>(second))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    find()</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;---&#x27;</span>)</span><br><span class="line">    check(<span class="number">8646064</span>, <span class="number">3945294</span>, <span class="number">1389537</span>)</span><br></pre></td></tr></table></figure>
<p>æœ€åå¯ä»¥å¾—åˆ°ç»“æœäº†ï¼š<code>(8646064, 3945294, 1389537, 0)</code></p>
]]></content>
      <categories>
        <category>éšç¬”</category>
      </categories>
      <tags>
        <tag>Puzzle</tag>
      </tags>
  </entry>
  <entry>
    <title>Lustre 101</title>
    <url>/2023/07/27/09/</url>
    <content><![CDATA[<h2 id="x00-lustre-intro">0x00 Lustre Intro</h2>
<p>This post is a brief introduction to Lustre, an open-source distributed clustered file system.</p>
<span id="more"></span>
<h2 id="x01-architecture">0x01 Architecture</h2>
<p>Lustre architecture</p>
<p><img src="lustre-arch.png" alt="æœªå‘½åæ–‡ä»¶" style="zoom:60%;" /></p>
<ul>
<li>å…ƒæ•°æ®æœåŠ¡å™¨ï¼ˆmetadata serverï¼ŒMDSï¼‰ï¼šä¸€ä¸ªLustreæ–‡ä»¶ç³»ç»Ÿé€šå¸¸æ‹¥æœ‰ä¸¤ä¸ªå…ƒæ•°æ®æœåŠ¡å™¨ï¼ˆactiveå’Œstandbyï¼‰ï¼Œä¸€ä¸ªå…ƒæ•°æ®æœåŠ¡å™¨åˆ™æ‹¥æœ‰è‹¥å¹²å…ƒæ•°æ®ç›®æ ‡ï¼ˆmetadata targetsï¼ŒMDTsï¼‰ã€‚å…ƒæ•°æ®ç›®æ ‡å­˜å‚¨å‘½åç©ºé—´å…ƒæ•°æ®ï¼šæ–‡ä»¶åã€ç›®å½•ã€è®¿é—®æƒé™ã€æ–‡ä»¶ç»“æ„ç­‰ä¿¡æ¯ã€‚ä¸åŒäºè¯¸å¦‚GPFSå’ŒPanFSç­‰åŸºäºå—å¹¶ç”±å…ƒæ•°æ®æœåŠ¡å™¨æ§åˆ¶æ‰€æœ‰å—åˆ†é…çš„åˆ†å¸ƒå¼æ–‡ä»¶ç³»ç»Ÿï¼ŒLustreå…ƒæ•°æ®æœåŠ¡å™¨ä»…ä»…å…³å¿ƒè·¯å¾„æœç´¢å’Œæƒé™æ£€æŸ¥è€Œä¸ä¼šç‰µæ¶‰ä»»ä½•çš„æ–‡ä»¶I/Oæ“ä½œã€‚è¯¥ç‰¹æ€§é¿å…å…ƒæ•°æ®æœåŠ¡å™¨æˆä¸ºé›†ç¾¤æ‰©å±•çš„ç“¶é¢ˆã€‚</li>
<li>å¯¹è±¡å­˜å‚¨æœåŠ¡å™¨ï¼ˆobject storage serverï¼ŒOSSï¼‰å°†æ–‡ä»¶æ•°æ®å­˜å‚¨äºä¸€ä¸ªæˆ–å¤šä¸ªå¯¹è±¡å­˜å‚¨ç›®æ ‡ï¼ˆobject storage targetï¼ŒOSTï¼‰ä¸­ã€‚å–å†³äºæœåŠ¡å™¨ç¡¬ä»¶ï¼Œä¸€ä¸ªå¯¹è±¡å­˜å‚¨æœåŠ¡å™¨é€šå¸¸æœ‰äºŒåˆ°å…«ä¸ªå¯¹è±¡å­˜å‚¨ç›®æ ‡ï¼Œæ¯ä¸ªå¯¹è±¡å­˜å‚¨ç›®æ ‡ç®¡ç†ä¸€ä¸ªæœ¬åœ°æ–‡ä»¶ç³»ç»Ÿã€‚Lustreæ–‡ä»¶ç³»ç»Ÿçš„ç©ºé—´ç­‰äºæ‰€æœ‰å¯¹è±¡å­˜å‚¨ç›®æ ‡çš„å®¹é‡æ€»å’Œã€‚</li>
<li>å®¢æˆ·æœºï¼ˆClientsï¼‰èƒ½è®¿é—®å¹¶ä½¿ç”¨æ•°æ®ã€‚Lustreä¸ºæ‰€æœ‰å®¢æˆ·æœºæä¾›ç»Ÿä¸€çš„å‘½åç©ºé—´ã€‚</li>
</ul>
<h2 id="x02-network">0x02 Network</h2>
<p>lustreæ˜¯åŸºäºRPCçš„ï¼Œä¸‹é¢æ˜¯æ•´ä¸ªRPC stackã€‚LNetæ˜¯è‡ªå·±åšflow controlçš„</p>
<figure class="highlight asciidoc"><table><tr><td class="code"><pre><span class="line"><span class="section">Node-specific lustre code</span></span><br><span class="line"><span class="section">=========================</span></span><br><span class="line"><span class="section">portal RPC</span></span><br><span class="line"><span class="section">=========================</span></span><br><span class="line"><span class="section">LNet(lustre networking)</span></span><br><span class="line"><span class="section">=========================</span></span><br><span class="line"><span class="section">LND(lustre network driver), o2iblnd(OFED 2nd IB LND)</span></span><br><span class="line"><span class="section">=========================</span></span><br><span class="line">OFED</span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>æ–‡ä»¶ç³»ç»Ÿ</category>
      </categories>
      <tags>
        <tag>Lustre</tag>
      </tags>
  </entry>
  <entry>
    <title>optimized_cpp-ch2</title>
    <url>/2021/11/13/39/</url>
    <content><![CDATA[<h1 id="ch2-å®ç°æ™ºèƒ½æŒ‡é’ˆ">Ch2 å®ç°æ™ºèƒ½æŒ‡é’ˆ</h1>
<p>æ™ºèƒ½æŒ‡é’ˆæœ€åŸºæœ¬çš„åŠŸèƒ½ï¼šå¯¹è¶…å‡ºä½œç”¨åŸŸçš„å¯¹è±¡è¿›è¡Œé‡Šæ”¾</p>
<span id="more"></span>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="comment">// class shape_type</span></span><br><span class="line"><span class="class"><span class="keyword">enum</span> <span class="keyword">class</span> <span class="title">shape_type</span> &#123;</span></span><br><span class="line">    circle,</span><br><span class="line">    triangle,</span><br><span class="line">    rectangle,</span><br><span class="line">&#125;;</span><br><span class="line"><span class="comment">// create shape</span></span><br><span class="line"><span class="function">shape* <span class="title">create_shape</span><span class="params">(shape_type type)</span> </span>&#123;</span><br><span class="line">    <span class="built_in"><span class="keyword">switch</span></span> (type) &#123;</span><br><span class="line">    <span class="keyword">case</span> shape_type::circle:</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">circle</span>();</span><br><span class="line">    <span class="keyword">case</span> shape_type::triangle:</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">triangle</span>();</span><br><span class="line">    <span class="keyword">case</span> shape_type::rectangle:</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">rectangle</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// wrapper</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">shape_wrapper</span> &#123;</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">  <span class="function"><span class="keyword">explicit</span> <span class="title">shape_wrapper</span><span class="params">(shape* ptr = <span class="literal">nullptr</span>)</span>: ptr_(ptr) &#123;</span>&#125;</span><br><span class="line">  ~<span class="built_in">shape_wrapper</span>() &#123;</span><br><span class="line">    <span class="keyword">delete</span> ptr_;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="function">shape* <span class="title">get</span><span class="params">()</span> <span class="keyword">const</span> </span>&#123; <span class="keyword">return</span> ptr_; &#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">  shape* ptr_;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="comment">// example function</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">foo</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    <span class="function">shape_wrapper <span class="title">ptr_wrapper</span><span class="params">(create_shape(...))</span></span>;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ä¸ºäº†ä¿è¯ä½¿ç”¨<code>create_shape</code>çš„è¿”å›å€¼æ—¶ï¼Œä¸ä¼šå‡ºç°å†…å­˜æ³„æ¼ã€‚æˆ‘ä»¬éœ€è¦æŠŠè¿™ä¸ªè¿”å›å€¼æ”¾åˆ°ä¸€ä¸ªæœ¬åœ°å˜é‡ä¸­ï¼Œå¹¶ç¡®ä¿å…¶ææ„å‡½æ•°ä¼šåˆ é™¤è¯¥å¯¹è±¡ã€‚</p>
<p><code>shape_wrapper</code>ä»ç„¶ç¼ºå°‘çš„åŠŸèƒ½ï¼š</p>
<ul>
<li>è¿™ä¸ªç±»åªé€‚ç”¨äºshapeç±»</li>
<li>è¡Œä¸ºä¸å¤ªåƒæŒ‡é’ˆ</li>
<li>æ‹·è´è¿™ç±»å¯¹è±¡ä¼šå¼•å‘å¼‚å¸¸</li>
</ul>
<p><strong>åŒ…è£…ä»»æ„ç±»å‹çš„æŒ‡é’ˆ</strong></p>
<p>ä½¿ç”¨æ¨¡æ¿ï¼š</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">typename</span> T&gt;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">smart_ptr</span> &#123;</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">  <span class="function"><span class="keyword">explicit</span> <span class="title">shape_wrapper</span><span class="params">(T* ptr = <span class="literal">nullptr</span>)</span>: ptr_(ptr) &#123;</span>&#125;</span><br><span class="line">  ~<span class="built_in">shape_wrapper</span>() &#123;</span><br><span class="line">    <span class="keyword">delete</span> ptr_;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="function">T* <span class="title">get</span><span class="params">()</span> <span class="keyword">const</span> </span>&#123; <span class="keyword">return</span> ptr_; &#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">  T* ptr_;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p><strong>ä½¿<code>smart_ptr</code>è¡Œä¸ºæ›´åƒæŒ‡é’ˆ</strong></p>
<p>æŒ‡é’ˆå¯ä»¥ï¼š</p>
<ul>
<li>ç”¨<code>*</code>è§£å¼•ç”¨</li>
<li>ç”¨<code>-&gt;</code>æŒ‡å‘å¯¹è±¡æˆå‘˜</li>
<li>ç”¨åœ¨å¸ƒå°”è¡¨è¾¾å¼ä¸­</li>
</ul>
<p>åŠ å‡ ä¸ªæˆå‘˜å‡½æ•°ï¼š</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">typename</span> T&gt;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">smart_ptr</span> &#123;</span></span><br><span class="line">	<span class="comment">//...</span></span><br><span class="line">	T&amp; <span class="keyword">operator</span>*() <span class="keyword">const</span> &#123;<span class="keyword">return</span> *ptr_;&#125;</span><br><span class="line">    T* <span class="keyword">operator</span>-&gt;() <span class="keyword">const</span> &#123;<span class="keyword">return</span> ptr_;&#125;</span><br><span class="line">    <span class="function"><span class="keyword">operator</span> <span class="title">bool</span><span class="params">()</span> <span class="keyword">const</span> </span>&#123;<span class="keyword">return</span> ptr_;&#125;</span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p><strong>æ‹·è´æ„é€ å’Œèµ‹å€¼</strong></p>
<p>åœ¨æ‹·è´æ™ºèƒ½æŒ‡é’ˆæ—¶ï¼Œå› ä¸ºå¯¹è±¡å¹¶æ²¡æœ‰å¤åˆ¶ä¸€ä»½ï¼Œå› æ­¤å¯èƒ½ä¼šå¯¹åŒä¸€å—å†…å­˜é‡Šæ”¾ä¸¤æ¬¡ï¼Œå¯¼è‡´ç¨‹åºå´©æºƒã€‚</p>
<p>å› æ­¤éœ€è¦ç¦ç”¨æ‹·è´ï¼š</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">typename</span> T&gt;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">smart_ptr</span> &#123;</span></span><br><span class="line">	<span class="comment">//...</span></span><br><span class="line">    <span class="built_in">smart_ptr</span>(<span class="keyword">const</span> smart_ptr&amp;)</span><br><span class="line">        = <span class="keyword">delete</span>;</span><br><span class="line">    smart_ptr&amp; <span class="keyword">operator</span>=(<span class="keyword">const</span> smart_ptr&amp;)</span><br><span class="line">        = <span class="keyword">delete</span>;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>ä½†æ˜¯<code>smart_ptr&lt;shape&gt; ptr2&#123;ptr1&#125;</code>ä»ç„¶å¯èƒ½å‡ºç°é‡Šæ”¾ä¸¤æ¬¡å†…å­˜çš„é”™è¯¯ã€‚</p>
<p>å› æ­¤å°è¯•åœ¨æ‹·è´æ—¶è½¬ç§»æŒ‡é’ˆçš„æ‰€æœ‰æƒï¼š</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">typename</span> T&gt;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">smart_ptr</span> &#123;</span></span><br><span class="line">    <span class="comment">// æ‹·è´æ„é€ å‡½æ•°</span></span><br><span class="line">    <span class="built_in">smart_ptr</span>(smart_ptr&amp; other) &#123;</span><br><span class="line">		ptr_ = other.<span class="built_in">release</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// èµ‹å€¼å‡½æ•°</span></span><br><span class="line">    smart_ptr&amp; <span class="keyword">operator</span>=(smart_ptr&amp; rhs) &#123;</span><br><span class="line">		<span class="built_in">smart_ptr</span>(rhs).<span class="built_in">swap</span>(*<span class="keyword">this</span>); <span class="comment">// æ„é€ ä¸´æ—¶å¯¹è±¡</span></span><br><span class="line">        <span class="keyword">return</span> *<span class="keyword">this</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// é‡Šæ”¾å¯¹æŒ‡é’ˆçš„æ‰€æœ‰æƒ</span></span><br><span class="line">    <span class="function">T* <span class="title">release</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        T* ptr = ptr_;</span><br><span class="line">        ptr_ = <span class="literal">nullptr</span>;</span><br><span class="line">        <span class="keyword">return</span> ptr;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// äº¤æ¢å¯¹æŒ‡é’ˆçš„æ‰€æœ‰æƒ</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">swap</span><span class="params">(smart_ptr&amp; rhs)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">using</span> std::swap;</span><br><span class="line">        <span class="built_in">swap</span>(ptr_, rhs.ptr_);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>ä¸Šé¢çš„å®ç°çš„é—®é¢˜æ˜¯ï¼š</p>
<p>å¦‚æœæŠŠä¸€ä¸ªsmart_pträ¼ é€’ç»™å¦ä¸€ä¸ªï¼Œä½ å°±ä¸å†æ‹¥æœ‰è¿™ä¸ªå¯¹è±¡äº†ã€‚</p>
<p><strong>ä½¿ç”¨â€œç§»åŠ¨â€æ”¹å–„smart_ptrçš„è¡Œä¸º</strong></p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">typename</span> T&gt;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">smart_ptr</span> &#123;</span></span><br><span class="line">    <span class="comment">// ç§»åŠ¨æ„é€ </span></span><br><span class="line">	<span class="built_in">smart_ptr</span>(smart_ptr&amp;&amp; other) &#123;</span><br><span class="line">		ptr_ = other.<span class="built_in">release</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// æ‹·è´æ„é€ </span></span><br><span class="line">    smart_ptr&amp; <span class="keyword">operator</span>=(smart_ptr rhs) &#123;</span><br><span class="line">        rhs.<span class="built_in">swap</span>(*<span class="keyword">this</span>);</span><br><span class="line">        <span class="keyword">return</span> *<span class="keyword">this</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>C++çš„è§„åˆ™ï¼š å¦‚æœæä¾›äº†ç§»åŠ¨æ„é€ å‡½æ•°è€Œæ²¡æœ‰æ‰‹åŠ¨æä¾›æ‹·è´æ„é€ å‡½æ•°ï¼Œé‚£ä¹ˆåè€…ä¼šè¢«ç¦ç”¨ã€‚</p>
</blockquote>
<p>å› æ­¤ï¼š</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line">smart_ptr&lt;shape&gt; ptr1&#123;<span class="built_in">create_shape</span>(shape_type::circle)&#125;;</span><br><span class="line">smart_ptr&lt;shape&gt; ptr2&#123;ptr1&#125;;             <span class="comment">// ç¼–è¯‘å‡ºé”™</span></span><br><span class="line">smart_ptr&lt;shape&gt; ptr3;</span><br><span class="line">ptr3 = ptr1;                             <span class="comment">// ç¼–è¯‘å‡ºé”™</span></span><br><span class="line">ptr3 = std::<span class="built_in">move</span>(ptr1);                  <span class="comment">// OKï¼Œå¯ä»¥</span></span><br><span class="line">smart_ptr&lt;shape&gt; ptr4&#123;std::<span class="built_in">move</span>(ptr3)&#125;;  <span class="comment">// OKï¼Œå¯ä»¥</span></span><br></pre></td></tr></table></figure>
<p>ä»¥ä¸Šå°±æ˜¯C++11çš„<code>unique_ptr</code>çš„åŸºæœ¬è¡Œä¸º</p>
<p>ä½†æ˜¯ï¼Œä¸€ä¸ª<code>circle*</code>å¯ä»¥éšå¼åœ°è½¬æ¢æˆ<code>shape*</code>ï¼Œè€Œä¸Šé¢åœ°<code>smart_ptr&lt;circle&gt;</code>å´ä¸èƒ½è‡ªåŠ¨è½¬æ¢æˆ<code>smart_ptr&lt;shape&gt;</code>ï¼Œè¿™è¿˜ä¸å¤Ÿè‡ªç„¶ã€‚</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">typename</span> U&gt;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">smart_ptr</span> &#123;</span></span><br><span class="line">	<span class="built_in">smart_ptr</span>(smart_ptr&lt;U&gt;&amp;&amp; other) &#123;</span><br><span class="line">        ptr_ = other.<span class="built_in">release</span>(); <span class="comment">// ä¸æ­£ç¡®çš„è½¬æ¢ä¼šåœ¨ç¼–è¯‘æ—¶æŠ¥é”™</span></span><br><span class="line">    &#125;  </span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>ä¸Šé¢çš„è¿™ä¸ªæ„é€ å‡½æ•°ä¸ä¼šè¢«ç¼–è¯‘å™¨çœ‹ä½œæ˜¯ç§»åŠ¨æ„é€ å‡½æ•°</p>
<p><strong>å¼•ç”¨è®¡æ•°</strong></p>
<p>å’Œ<code>unique_ptr</code>ç›¸æ¯”ï¼Œå¤šä¸ª<code>shared_ptr</code>å¯ä»¥åŒæ—¶æ‹¥æœ‰ä¸€ä¸ªå¯¹è±¡ï¼Œå› æ­¤å®ƒä»¬éœ€è¦å…±äº«ä¸€ä¸ªè®¡æ•°ã€‚</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">shared_count</span> &#123;</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">	<span class="built_in">shared_count</span>();</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">add_count</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">long</span> <span class="title">reduce_count</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">long</span> <span class="title">get_count</span><span class="params">()</span> <span class="keyword">const</span></span>;</span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    <span class="keyword">long</span> count;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>æ·»åŠ äº†shared_countçš„smart_ptrï¼š</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">typename</span> T&gt;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">smart_ptr</span> &#123;</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="keyword">explicit</span> <span class="title">smart_ptr</span><span class="params">(T* ptr = <span class="literal">nullptr</span>)</span>: ptr_(ptr) &#123;</span></span><br><span class="line">        <span class="keyword">if</span>(ptr) &#123;</span><br><span class="line">            shared_count_ = <span class="keyword">new</span> <span class="built_in">shared_count</span>();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    ~<span class="built_in">smart_ptr</span>() &#123;</span><br><span class="line">        <span class="keyword">if</span>(ptr_ &amp;&amp; shared_count_-&gt;<span class="built_in">reduce_count</span>()) &#123;</span><br><span class="line">            <span class="keyword">delete</span> ptr_;</span><br><span class="line">            <span class="keyword">delete</span> shared_count_;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    T* ptr_;</span><br><span class="line">    shared_count* shared_count_;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>æ–°çš„swapå‡½æ•°ï¼š</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">swap</span><span class="params">(smart_ptr&amp; rhs)</span> </span>&#123;</span><br><span class="line">	<span class="keyword">using</span> std::swap;</span><br><span class="line">	<span class="built_in">swap</span>(ptr_, rhs.ptr_);</span><br><span class="line">	<span class="built_in">swap</span>(shared_count_, rhs.shared_count_);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æ–°çš„æ‹·è´æ„é€ ï¼Œç§»åŠ¨æ„é€ å‡½æ•°ï¼š</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="built_in">smart_ptr</span>(<span class="keyword">const</span> smart_ptr&amp; other) &#123;</span><br><span class="line">    ptr_ = other.ptr_;</span><br><span class="line">    <span class="keyword">if</span> (ptr_) &#123;</span><br><span class="line">      other.shared_count_-&gt;<span class="built_in">add_count</span>();</span><br><span class="line">      shared_count_ = other.shared_count_;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">typename</span> U&gt;</span><br><span class="line"><span class="built_in">smart_ptr</span>(<span class="keyword">const</span> smart_ptr&lt;U&gt;&amp; other) &#123;</span><br><span class="line">    ptr_ = other.ptr_;</span><br><span class="line">    <span class="keyword">if</span> (ptr_) &#123;</span><br><span class="line">      other.shared_count_-&gt;<span class="built_in">add_count</span>();</span><br><span class="line">      shared_count_ = other.shared_count_;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">typename</span> U&gt;</span><br><span class="line"><span class="built_in">smart_ptr</span>(smart_ptr&lt;U&gt;&amp;&amp; other) &#123;</span><br><span class="line">    ptr_ = other.ptr_;</span><br><span class="line">    <span class="keyword">if</span> (ptr_) &#123;</span><br><span class="line">      shared_count_ = other.shared_count_;</span><br><span class="line">      other.ptr_ = <span class="literal">nullptr</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>æŒ‡é’ˆç±»å‹è½¬æ¢</strong></p>
<p>c++ä¸­æœ‰ä¸åŒçš„ç±»å‹å¼ºåˆ¶è½¬æ¢ï¼š <code>static_cast</code>ã€<code>reinterpret_cast</code>ã€<code>const_cast</code>ã€<code>dynamic_cast</code></p>
]]></content>
      <categories>
        <category>è¯­è¨€</category>
      </categories>
      <tags>
        <tag>C++</tag>
      </tags>
  </entry>
  <entry>
    <title>gdbã€å¸¸ç”¨å¯„å­˜å™¨</title>
    <url>/2021/11/22/50/</url>
    <content><![CDATA[<h1 id="ç®€ä»‹">ç®€ä»‹</h1>
<p>æœ€è¿‘åœ¨å†™CSAPPçš„bomb labï¼Œéœ€è¦ç”¨gdbè°ƒè¯•ï¼Œè¿˜æ¶‰åŠåˆ°ä¸€äº›æ±‡ç¼–çš„ä»£ç ã€‚è¿™é‡Œè®°å½•ä¸€ä¸‹gdbè°ƒè¯•çš„æ–¹æ³•ï¼Œä»¥åŠå¸¸ç”¨å¯„å­˜å™¨çš„ä½œç”¨ã€‚</p>
<span id="more"></span>
<h2 id="gdb">gdb</h2>
<table>
<colgroup>
<col style="width: 25%" />
<col style="width: 74%" />
</colgroup>
<thead>
<tr class="header">
<th><code>r</code></th>
<th>è¿è¡Œç¨‹åº</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><code>b *&lt;åœ°å€&gt;</code></td>
<td>åœ¨æŸä¸ªåœ°å€è®¾ç½®æ–­ç‚¹ï¼Œå…·ä½“å“ªé‡Œï¼Œå¯ä»¥çœ‹åæ±‡ç¼–çš„ä»£ç ï¼Œå¯ä»¥æ ¹æ®é‚£ä¸ªç›´æ¥å¤åˆ¶ç²˜è´´è®¾æ–­ç‚¹çš„</td>
</tr>
<tr class="even">
<td><code>d</code></td>
<td>åˆ é™¤æ‰€æœ‰æ–­ç‚¹</td>
</tr>
<tr class="odd">
<td><code>d &lt;æ–­ç‚¹ç¼–å·&gt;</code></td>
<td>åˆ é™¤æŒ‡å®šæ–­ç‚¹</td>
</tr>
<tr class="even">
<td><code>info b</code></td>
<td>æŸ¥çœ‹æ‰€æœ‰æ–­ç‚¹</td>
</tr>
<tr class="odd">
<td><code>continue</code></td>
<td>ä»æ–­ç‚¹å¤„ç»§ç»­æ‰§è¡Œ</td>
</tr>
<tr class="even">
<td><code>display $&lt;å¯„å­˜å™¨å&gt;</code></td>
<td>è·Ÿè¸ªå¯„å­˜å™¨ï¼Œç¢°åˆ°æ–­ç‚¹åœä¸‹æ—¶ä¼šæ˜¾ç¤ºå‡ºæ‰€æœ‰è·Ÿè¸ªçš„å¯„å­˜å™¨çš„å½“å‰å€¼ï¼Œéå¸¸å¥½ç”¨çš„ä¸€ä¸ªå‘½ä»¤ï¼Œæ³¨æ„çš„æ˜¯gdbä¸­è¡¨ç¤ºå¯„å­˜å™¨çš„è¯å‰é¢ç”¨çš„ä¸æ˜¯ç™¾åˆ†ç¬¦å·%ï¼Œè€Œæ˜¯ç¾å…ƒç¬¦å·$</td>
</tr>
<tr class="odd">
<td><code>x/&lt;å‚æ•°&gt; &lt;åœ°å€&gt;</code></td>
<td>è®¿é—®åœ°å€çš„å†…å­˜ï¼Œå…¶å®å°±æ˜¯é—´æ¥è®¿é—®ï¼Œä¹Ÿæ˜¯å¾ˆå¥½ç”¨çš„æŒ‡ä»¤ï¼Œå…³äºå‚æ•°ï¼Œsæ˜¯è¾“å‡ºä¸ºå­—ç¬¦ä¸²ï¼Œdä¸ºè¾“å‡ºä¸ºåè¿›åˆ¶ï¼Œxä¸ºè¾“å‡ºä¸ºåå…­è¿›åˆ¶ï¼Œbã€wã€lã€qæ§åˆ¶è¾“å‡ºå­—èŠ‚ï¼Œé»˜è®¤æ˜¯wï¼Œå››å­—èŠ‚ï¼Œså­—ç¬¦ä¸²ä¸å—è¿™ä¸ªæ§åˆ¶é™¤å¤–ã€‚</td>
</tr>
<tr class="even">
<td><code>info r</code></td>
<td>æŸ¥çœ‹æ‰€æœ‰å¯„å­˜å™¨</td>
</tr>
</tbody>
</table>
<p>ç”¨gdbè¿è¡Œå¸¦å‚æ•°çš„å¯æ‰§è¡Œæ–‡ä»¶ï¼š</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">gdb --args bomb defuse	// defuseæ˜¯å‚æ•°</span><br></pre></td></tr></table></figure>
<h2 id="å¸¸ç”¨å¯„å­˜å™¨">å¸¸ç”¨å¯„å­˜å™¨</h2>
<p>å¯„å­˜å™¨ä¸€èˆ¬ä»¥<code>e</code>æˆ–<code>r</code>å¼€å¤´ï¼Œ<code>e</code>ä»£è¡¨32ä½ï¼Œ<code>r</code>ä»£è¡¨64ä½ã€‚</p>
<p>ä¸€èˆ¬å¯„å­˜å™¨ï¼šAXã€BXã€CXã€DX AXï¼šç´¯ç§¯æš‚å­˜å™¨ï¼ŒBX:åŸºåº•æš‚å­˜å™¨ï¼ŒCX:è®¡æ•°æš‚å­˜å™¨ï¼ŒDX:èµ„æ–™æš‚å­˜å™¨</p>
<blockquote>
<p>å‰é¢æœ‰å‡½æ•°è°ƒç”¨çš„è¯ï¼Œä¸€èˆ¬<code>%rax</code>å°±æ˜¯ç¨‹åºçš„è¿”å›å€¼</p>
</blockquote>
<p>ç´¢å¼•æš‚å­˜å™¨ï¼šSIã€DI SIï¼šæ¥æºç´¢å¼•æš‚å­˜å™¨ï¼ŒDIï¼šç›®çš„ç´¢å¼•æš‚å­˜å™¨</p>
<p>å †å ã€åŸºåº•æš‚å­˜å™¨ï¼šSPã€BP SPï¼šå †å æŒ‡æ ‡æš‚å­˜å™¨ï¼ŒBPï¼šåŸºåº•æŒ‡æ ‡æš‚å­˜å™¨</p>
<p><code>ebp</code>ç§°ä¸ºåŸºå€æŒ‡é’ˆï¼ˆbase pointerï¼‰ï¼Œåœ¨åç¼–è¯‘çš„æ–‡ä»¶ä¸­ï¼Œç»å¸¸å¯ä»¥çœ‹åˆ°ä¸€ä¸ªå‡½æ•°çš„èµ·å§‹ä»£ç ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">push ebp 		;ä¿å­˜å½“å‰ebp</span><br><span class="line">mov ebp,esp 	;EBPè®¾ä¸ºå½“å‰å †æ ˆæŒ‡é’ˆ</span><br><span class="line">sub esp, xxx 	;é¢„ç•™xxxå­—èŠ‚ç»™å‡½æ•°ä¸´æ—¶å˜é‡.</span><br><span class="line">...</span><br><span class="line"></span><br><span class="line">; bomb example</span><br><span class="line">0000000000400efc &lt;phase_2&gt;:</span><br><span class="line">  400efc:	55                   	push   %rbp</span><br><span class="line">  400efd:	53                   	push   %rbx</span><br><span class="line">  400efe:	48 83 ec 28          	sub    $0x28,%rsp</span><br><span class="line">  400f02:	48 89 e6             	mov    %rsp,%rsi</span><br><span class="line">  ; ...</span><br><span class="line">  400f3c:	48 83 c4 28          	add    $0x28,%rsp</span><br><span class="line">  400f40:	5b                   	pop    %rbx</span><br><span class="line">  400f41:	5d                   	pop    %rbp</span><br><span class="line">  400f42:	c3                   	retq   </span><br></pre></td></tr></table></figure>
<p>è¿™æ ·ä¸€æ¥ï¼ŒEBP æ„æˆäº†è¯¥å‡½æ•°çš„ä¸€ä¸ªæ¡†æ¶ï¼Œåœ¨EBPä¸Šæ–¹åˆ†åˆ«æ˜¯åŸæ¥çš„EBPï¼Œè¿”å›åœ°å€å’Œå‚æ•°ã€‚</p>
<p><code>esp</code>ä¸“é—¨ç”¨ä½œå †æ ˆæŒ‡é’ˆï¼Œè¢«å½¢è±¡åœ°ç§°ä¸ºæ ˆé¡¶æŒ‡é’ˆï¼Œå †æ ˆçš„é¡¶éƒ¨æ˜¯åœ°å€å°çš„åŒºåŸŸï¼Œå‹å…¥å †æ ˆçš„æ•°æ®è¶Šå¤šï¼Œ<code>esp</code>ä¹Ÿå°±è¶Šæ¥è¶Šå°ã€‚åœ¨32ä½å¹³å°ä¸Šï¼Œ<code>esp</code>æ¯æ¬¡å‡å°‘4å­—èŠ‚ã€‚</p>
]]></content>
      <categories>
        <category>æ“ä½œç³»ç»Ÿ</category>
      </categories>
      <tags>
        <tag>Register</tag>
        <tag>GDB</tag>
      </tags>
  </entry>
  <entry>
    <title>äº‘æœåŠ¡å™¨éƒ¨ç½² Grafana ç›‘æ§è®°å½•</title>
    <url>/2023/07/19/33/</url>
    <content><![CDATA[<h2 id="x00-ç®€ä»‹">0x00 ç®€ä»‹</h2>
<p>è®°å½•åœ¨è…¾è®¯äº‘æœåŠ¡å™¨ä¸Šé¢é…ç½®prometheus+grafanaï¼Œç›‘è§†äº‘ä¸»æœºè¿è¡ŒçŠ¶æ€çš„è¿‡ç¨‹ã€‚</p>
<span id="more"></span>
<h2 id="x01-æ•´ä½“ç»“æ„">0x01 æ•´ä½“ç»“æ„</h2>
<p>è¦éƒ¨ç½²çš„æœåŠ¡æœ‰prometheusã€grafanaã€node_exporterï¼Œå‰ä¸¤ä¸ªåœ¨dockerä¸­éƒ¨ç½²ï¼Œnode_exporterå› ä¸ºè¦é‡‡é›†å®¿ä¸»æœºçš„æŒ‡æ ‡ä¿¡æ¯ï¼Œæ‰€ä»¥æ²¡æœ‰ç”¨dockerè¿è¡Œã€‚</p>
<p>æ•°æ®ä¸ŠæŠ¥çš„è¿‡ç¨‹æ˜¯ï¼š</p>
<p>node_exporter (9100 port) =&gt; prometheus (9090 port) =&gt; grafana (3000 port)</p>
<h2 id="x02-éƒ¨ç½²è¿‡ç¨‹">0x02 éƒ¨ç½²è¿‡ç¨‹</h2>
<p><strong>Docker</strong></p>
<p>éƒ¨ç½²æ¯”è¾ƒç®€å•ï¼Œæ‹‰å–é•œåƒï¼ŒæŒ‡å®šé…ç½®æ–‡ä»¶æ˜ å°„ï¼Œå†å¯åŠ¨å®¹å™¨å°±okäº†ã€‚</p>
<p>grafanaå®˜æ–¹ç½‘ç«™æœ‰ä¸€äº›dashboardæ¨¡æ¿ï¼Œå¯ä»¥é€šè¿‡IDå¯¼å…¥ï¼Œçœå»äº†è‡ªå»ºdashboardçš„éº»çƒ¦ã€‚</p>
<p><strong>æ•ˆæœå›¾</strong></p>
<figure>
<img src="image-20230719160454386.png" alt="image-20230719160454386" /><figcaption aria-hidden="true">image-20230719160454386</figcaption>
</figure>
<h2 id="x03-å…¶ä»–">0x03 å…¶ä»–</h2>
<p>å› ä¸ºprometheuså’Œgrafanaæ˜¯é€šè¿‡dockerå¯åŠ¨çš„ï¼Œåœ¨é…ç½®é‡Œé¢è¦ç”¨dockerå®¹å™¨çš„ip</p>
<figure>
<img src="image-20230719160714202.png" alt="image-20230719160714202" /><figcaption aria-hidden="true">image-20230719160714202</figcaption>
</figure>
<p>æŸ¥è¯¢å®¹å™¨çš„ipï¼š</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">docker inspect -f <span class="string">&#x27;&#123;&#123;range .NetworkSettings.Networks&#125;&#125;&#123;&#123;.IPAddress&#125;&#125;&#123;&#123;end&#125;&#125;&#x27;</span> &lt;container_name_or_id&gt;</span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>æ•°æ®å¯è§†åŒ–</category>
      </categories>
      <tags>
        <tag>Grafana</tag>
        <tag>Docker</tag>
      </tags>
  </entry>
</search>
